#!/usr/bin/env bash
set -euo pipefail

GRADLE="./gradlew"; [ -x "$GRADLE" ] || GRADLE="gradle"
echo "🔍 Pre-commit checks"

# Java 변경 없으면 스킵(원하면 제거)
if ! git diff --cached --name-only | grep -E '^src/.*\.java$' >/dev/null 2>&1; then
  echo "ℹ️ Staged Java 변경 없음 → 스킵"; exit 0; fi

# 포맷 체크 → 자동수정 후 커밋 중단
if ! $GRADLE -q spotlessCheck; then
  echo "🧹 Formatting issues → spotlessApply"
  $GRADLE -q spotlessApply
  git add -A
  echo "❗ 포맷 자동 수정됨. 변경 확인 후 다시 커밋하세요."
  exit 1
fi

# 정적 분석 + 테스트
$GRADLE -q preCommit
echo "✅ OK"